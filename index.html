<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小铭的论文助手</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --accent-color: #2196F3;
            --hover-color: #1976D2;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --border-color: #333333;
            --accent-color: #64B5F6;
            --hover-color: #90CAF9;
            --shadow-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 用户状态栏 */
        .user-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .user-bar span {
            color: var(--text-color);
        }

        .user-bar button {
            padding: 8px 16px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .user-bar button:hover {
            background-color: var(--hover-color);
        }

        .user-bar .logout-btn {
            background-color: #f44336;
        }

        .user-bar .logout-btn:hover {
            background-color: #d32f2f;
        }

        /* 登录/注册模态框 */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .auth-modal-content {
            background-color: var(--bg-color);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .auth-modal h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .auth-form button:hover {
            background-color: var(--hover-color);
        }

        .auth-switch {
            text-align: center;
            margin-top: 15px;
            color: var(--text-color);
        }

        .auth-switch a {
            color: var(--accent-color);
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-color);
        }

        .auth-close:hover {
            color: var(--accent-color);
        }

        .auth-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            text-align: center;
            display: none;
        }

        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }

        .api-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .api-section h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        #model-select {
            padding: 12px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        #model-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #api-key-input {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        #api-key-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        #save-api-key {
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        #save-api-key:hover {
            background-color: var(--hover-color);
        }

        .domain-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .domain-section h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        #title-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        #title-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .editor-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

        .editor-column:nth-child(2) .editor-section {
            flex: 1;
            min-height: 400px;
        }

        .editor-section {
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 350px;
        }

        .editor-section h3 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 18px;
        }

        .editor-textarea {
            flex: 1;
            padding: 15px;
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s;
            font-family: 'Times New Roman', Times, serif;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .read-only-textarea {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            cursor: text;
        }

        .copy-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .copy-btn:hover {
            background-color: var(--hover-color);
        }

        .copy-btn:active {
            transform: scale(0.98);
        }

        .toggle-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .toggle-btn.active {
            background-color: #f44336;
            color: white;
        }

        .toggle-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: var(--bg-color);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }

        footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: var(--text-color);
            border-top: 1px solid var(--border-color);
        }

        .auxiliary-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background-color: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .auxiliary-section button {
            padding: 12px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .auxiliary-section button:hover {
            background-color: var(--hover-color);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #font-size-slider {
            width: 150px;
        }

        #font-size-value {
            font-size: 16px;
            color: var(--accent-color);
        }

        .loading {
            color: var(--accent-color);
            font-weight: bold;
            padding: 10px;
        }

        @media (max-width: 1024px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }

        .synchronized-scroll {
            overflow: auto;
        }

        .dark-mode .modal-content {
            background-color: #2a2a2a;
        }

        .dark-mode .help-section {
            background-color: #333 !important;
        }

        .dark-mode .auth-modal-content {
            background-color: #2a2a2a;
        }

        /* 需要登录提示 */
        .login-required-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 500;
            justify-content: center;
            align-items: center;
        }

        .login-required-box {
            background-color: var(--bg-color);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .login-required-box h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .login-required-box p {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .login-required-box button {
            padding: 12px 30px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }

        .login-required-box button:hover {
            background-color: var(--hover-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: var(--accent-color); margin-bottom: 30px; font-size: 32px;">小铭的论文助手</h1>

        <!-- 用户状态栏 -->
        <div class="user-bar">
            <div id="guest-buttons">
                <button onclick="showAuthModal('login')">登录</button>
                <button onclick="showAuthModal('register')">注册</button>
            </div>
            <div id="user-info" style="display: none;">
                <span>欢迎，<span id="user-email-display"></span></span>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>
        </div>

        <!-- 登录/注册模态框 -->
        <div id="auth-modal" class="auth-modal">
            <div class="auth-modal-content">
                <span class="auth-close" onclick="closeAuthModal()">&times;</span>
                
                <!-- 登录表单 -->
                <div id="login-form-container">
                    <h2>登录</h2>
                    <div id="login-message" class="auth-message"></div>
                    <form class="auth-form" onsubmit="handleLogin(event)">
                        <input type="email" id="login-email" placeholder="邮箱地址" required>
                        <input type="password" id="login-password" placeholder="密码" required>
                        <button type="submit">登录</button>
                    </form>
                    <p class="auth-switch">还没有账号？<a onclick="switchAuthForm('register')">立即注册</a></p>
                </div>

                <!-- 注册表单 -->
                <div id="register-form-container" style="display: none;">
                    <h2>注册</h2>
                    <div id="register-message" class="auth-message"></div>
                    <form class="auth-form" onsubmit="handleRegister(event)">
                        <input type="email" id="register-email" placeholder="邮箱地址" required>
                        <input type="password" id="register-password" placeholder="密码（至少6位）" required minlength="6">
                        <input type="password" id="register-password-confirm" placeholder="确认密码" required minlength="6">
                        <button type="submit">注册</button>
                    </form>
                    <p class="auth-switch">已有账号？<a onclick="switchAuthForm('login')">立即登录</a></p>
                </div>
            </div>
        </div>

        <!-- API设置区 -->
        <div class="api-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>AI服务设置</h2>
                <button id="help-btn" class="toggle-btn" style="background-color: #4CAF50; color: white;">API获取帮助</button>
            </div>
            <div class="api-input-group">
                <select id="model-select">
                    <option value="openai">OpenAI (GPT-3.5/4)</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="kimi">Kimi (Moonshot)</option>
                    <option value="doubao">豆包</option>
                    <option value="qianwen">千问 (Qianwen)</option>
                </select>
                <input type="password" id="api-key-input" placeholder="请输入对应AI模型的API密钥">
                <button id="save-api-key">保存密钥</button>
            </div>
            <p style="margin-top: 10px; font-size: 14px; color: #666;">提示：你需要在对应AI平台申请API密钥才能使用真实的AI功能。密钥仅保存在本地浏览器中。</p>
        </div>

        <!-- API帮助模态框 -->
        <div id="api-help-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeApiHelpModal()" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2 style="margin-bottom: 20px;">如何获取各个AI平台的API密钥</h2>
                
                <div class="help-section" style="margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>1. OpenAI (GPT-3.5/4)</h3>
                    <ol style="padding-left: 20px; margin-top: 10px;">
                        <li>访问OpenAI官网 <a href="https://platform.openai.com/" target="_blank">https://platform.openai.com/</a></li>
                        <li>登录或注册OpenAI账号</li>
                        <li>点击右上角用户头像，选择"View API keys"</li>
                        <li>点击"Create new secret key"按钮创建新密钥</li>
                        <li>复制并保存生成的API密钥（只能查看一次）</li>
                    </ol>
                </div>
                
                <div class="help-section" style="margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>2. DeepSeek</h3>
                    <ol style="padding-left: 20px; margin-top: 10px;">
                        <li>访问DeepSeek开放平台 <a href="https://platform.deepseek.com/" target="_blank">https://platform.deepseek.com/</a></li>
                        <li>登录或注册账号</li>
                        <li>进入API keys管理页面</li>
                        <li>点击"创建API key"按钮</li>
                        <li>设置API名称，点击"创建"</li>
                        <li>复制生成的API密钥</li>
                    </ol>
                </div>
                
                <div class="help-section" style="margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>3. Kimi (Moonshot)</h3>
                    <ol style="padding-left: 20px; margin-top: 10px;">
                        <li>访问Moonshot AI官网 <a href="https://platform.moonshot.cn/" target="_blank">https://platform.moonshot.cn/</a></li>
                        <li>登录或注册账号</li>
                        <li>点击左侧菜单的"API密钥"</li>
                        <li>点击"创建新密钥"</li>
                        <li>设置密钥名称，点击"创建"</li>
                        <li>复制生成的API密钥</li>
                    </ol>
                </div>
                
                <div class="help-section" style="margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>4. 豆包</h3>
                    <ol style="padding-left: 20px; margin-top: 10px;">
                        <li>访问字节跳动云平台 <a href="https://www.volcengine.com/" target="_blank">https://www.volcengine.com/</a></li>
                        <li>登录或注册账号</li>
                        <li>搜索并进入"豆包大模型"服务</li>
                        <li>进入API管理页面</li>
                        <li>创建API密钥</li>
                        <li>复制生成的API密钥</li>
                    </ol>
                </div>
                
                <div class="help-section" style="margin: 20px 0; padding: 20px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3>5. 阿里千问</h3>
                    <ol style="padding-left: 20px; margin-top: 10px;">
                        <li>访问阿里灵积平台 <a href="https://dashscope.aliyun.com/" target="_blank">https://dashscope.aliyun.com/</a></li>
                        <li>登录阿里云账号</li>
                        <li>进入API密钥管理页面</li>
                        <li>点击"创建API密钥"</li>
                        <li>复制生成的API密钥</li>
                    </ol>
                </div>
                
                <p style="margin-top: 20px; color: #f44336; font-weight: bold;">注意：API密钥是您的重要信息，请妥善保管，不要分享给他人。</p>
            </div>
        </div>

        <!-- 领域定位区 -->
        <div class="domain-section">
            <h2>领域定位</h2>
            <input type="text" id="title-input" placeholder="请输入论文题目（AI将自动识别专业领域）">
        </div>

        <!-- 左右两列布局 -->
        <div class="editor-container">
            <!-- 左侧列：原文输入和英文翻译 -->
            <div class="editor-column">
                <div class="editor-section">
                    <h3>原文输入区</h3>
                    <textarea id="original-text" class="editor-textarea synchronized-scroll" placeholder="请输入论文原文..."></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="copy-btn" onclick="triggerAIProcessing()">确认翻译</button>
                        <button class="copy-btn" onclick="copyContent('original-text')">复制内容</button>
                    </div>
                    <div id="loading-1" class="loading" style="display: none;">AI正在处理...</div>
                </div>

                <div class="editor-section">
                    <h3>英文翻译区 (SCI期刊标准)</h3>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" id="reverse-original-eng" name="reverse-source" value="original-eng" onclick="selectReverseSource('original-eng')">
                        <label for="reverse-original-eng" style="margin-left: 5px;">选择此翻译进行逆向验证</label>
                    </div>
                    <textarea id="english-translated" class="editor-textarea read-only-textarea synchronized-scroll" readonly placeholder="AI翻译的英文内容（符合SCI期刊标准）将显示在这里..."></textarea>
                    <button class="copy-btn" onclick="copyContent('english-translated')">复制内容</button>
                    <button class="toggle-btn" id="toggle-original-eng" onclick="toggleSection('original-eng')">屏蔽</button>
                </div>
            </div>

            <!-- 右侧列：中文润色和逆向验证 -->
            <div class="editor-column">
                <div class="editor-section">
                    <h3>中文润色区 (研究论文规范语言)</h3>
                    <textarea id="chinese-polished" class="editor-textarea read-only-textarea synchronized-scroll" readonly placeholder="AI润色后的中文内容将显示在这里..."></textarea>
                    <button class="copy-btn" onclick="copyContent('chinese-polished')">复制内容</button>
                    <button class="toggle-btn" id="toggle-chinese" onclick="toggleSection('chinese')">屏蔽</button>
                </div>

                <div class="editor-section">
                    <h3>润色后英文翻译区 (SCI标准)</h3>
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="radio" id="reverse-polished-eng" name="reverse-source" value="polished-eng" onclick="selectReverseSource('polished-eng')" checked>
                        <label for="reverse-polished-eng" style="margin-left: 5px;">选择此翻译进行逆向验证</label>
                    </div>
                    <textarea id="polished-english" class="editor-textarea read-only-textarea synchronized-scroll" readonly placeholder="润色后中文内容的英文翻译（符合SCI期刊标准）将显示在这里..."></textarea>
                    <button class="copy-btn" onclick="copyContent('polished-english')">复制内容</button>
                    <button class="toggle-btn" id="toggle-polished-eng" onclick="toggleSection('polished-eng')">屏蔽</button>
                </div>

                <div class="editor-section">
                    <h3 id="reverse-title">逆向验证区 (润色英译文的中文回译)</h3>
                    <textarea id="reverse-translation" class="editor-textarea read-only-textarea synchronized-scroll" readonly placeholder="用于内容一致性校验的中文回译将显示在这里..."></textarea>
                    <button class="copy-btn" onclick="copyContent('reverse-translation')">复制内容</button>
                    <button class="toggle-btn" id="toggle-reverse" onclick="toggleSection('reverse')">屏蔽</button>
                </div>
            </div>
        </div>

        <!-- 辅助功能区 -->
        <div class="auxiliary-section">
            <button id="mode-toggle">切换深色/浅色模式</button>
            
            <div class="font-size-control">
                <label for="font-size-slider">字体大小:</label>
                <input type="range" id="font-size-slider" min="12" max="24" value="14">
                <span id="font-size-value">14px</span>
            </div>
        </div>

        <!-- 赞助区域 -->
        <div class="donation-section" style="margin-top: 30px;">
            <div style="display: flex; align-items: center; gap: 20px; max-width: 800px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); border-radius: 8px; box-shadow: 0 2px 8px var(--shadow-color);">
                <div style="flex: 1;">
                    <p style="font-size: 16px; line-height: 1.6;">
                        本网站目前向科研人员免费开放，用于学术写作润色与翻译等辅助工作。为持续覆盖服务器租赁、模型调用与系统维护等基础运营成本，我们设置了自愿赞助选项。赞助完全出于自主意愿，不会影响功能使用，也不构成任何强制或附加服务承诺。感谢每一位用户的支持与反馈，它将帮助我们把工具长期、稳定地维护下去。
                    </p>
                </div>
                <div style="text-align: center;">
                    <img src="zan.png" alt="赞助二维码" style="max-width: 200px; height: auto; border-radius: 8px;">
                    <p style="margin-top: 10px; font-size: 14px; color: var(--text-color);">自愿赞助二维码</p>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer style="text-align: center; padding: 20px; color: #666; font-size: 14px; margin-top: 40px; border-top: 1px solid var(--border-color);">
            <p>商业合作邮箱：380015395@qq.com</p>
            <p style="margin-top: 10px; font-size: 12px;">
                本站总访问量 <span id="busuanzi_value_site_pv">--</span> 次 | 
                访客数 <span id="busuanzi_value_site_uv">--</span> 人
            </p>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        </footer>
    </div>

    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://kwlefsgpatdiuguicvus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3bGVmc2dwYXRkaXVndWljdnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDc3NTcsImV4cCI6MjA4MjU4Mzc1N30.Py30SZKqLTAzPGnk_-pdNFxQCUR0ZhHvWVSbCuE0_FU';
        
        // 等待 Supabase SDK 加载完成
        let supabaseClient = null;
        
        function initSupabase() {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            }
            return false;
        }
        
        // 尝试初始化，如果失败则延迟重试
        if (!initSupabase()) {
            const checkInterval = setInterval(() => {
                if (initSupabase()) {
                    clearInterval(checkInterval);
                    checkLoginStatus();
                }
            }, 100);
        }

        // 当前用户
        let currentUser = null;

        // API密钥和模型存储
        let apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || {};
        let currentModel = 'openai';
        
        // 逆向验证源选择
        let selectedReverseSource = 'polished-eng';

        // 区域屏蔽状态
        let sectionStates = {
            'chinese': false,
            'polished-eng': false,
            'original-eng': false,
            'reverse': false
        };

        // 模型API配置
        const modelConfigs = {
            openai: {
                apiUrl: 'https://api.openai.com/v1/chat/completions',
                model: 'gpt-3.5-turbo'
            },
            deepseek: {
                apiUrl: 'https://api.deepseek.com/v1/chat/completions',
                model: 'deepseek-chat'
            },
            kimi: {
                apiUrl: 'https://api.moonshot.cn/v1/chat/completions',
                model: 'moonshot-v1-8k'
            },
            doubao: {
                apiUrl: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                model: 'doubao-pro-4k'
            },
            qianwen: {
                apiUrl: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                model: 'qwen-turbo'
            }
        };

        // 检查登录状态
        async function checkLoginStatus() {
            if (!supabaseClient) return;
            
            // 检查用户登录状态
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                updateUIForLoggedInUser();
            }

            // 监听登录状态变化
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (session) {
                    currentUser = session.user;
                    updateUIForLoggedInUser();
                } else {
                    currentUser = null;
                    updateUIForLoggedOutUser();
                }
            });
        }

        // 页面加载时检查登录状态
        window.addEventListener('load', async function() {
            if (supabaseClient) {
                checkLoginStatus();
            }

            // 恢复已保存的API密钥
            if (apiKeys[currentModel]) {
                document.getElementById('api-key-input').value = apiKeys[currentModel];
            }

            // 恢复深色模式设置
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('mode-toggle').textContent = '切换浅色模式';
            }

            // 恢复字体大小设置
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                document.getElementById('font-size-slider').value = savedFontSize;
                document.getElementById('font-size-value').textContent = savedFontSize + 'px';
                document.querySelectorAll('.editor-textarea').forEach(textArea => {
                    textArea.style.fontSize = savedFontSize + 'px';
                });
            }
        });

        // 更新UI为已登录状态
        function updateUIForLoggedInUser() {
            document.getElementById('guest-buttons').style.display = 'none';
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('user-email-display').textContent = currentUser.email;
        }

        // 更新UI为未登录状态
        function updateUIForLoggedOutUser() {
            document.getElementById('guest-buttons').style.display = 'flex';
            document.getElementById('user-info').style.display = 'none';
        }

        // 显示登录/注册模态框
        function showAuthModal(type) {
            document.getElementById('auth-modal').style.display = 'block';
            switchAuthForm(type);
        }

        // 关闭模态框
        function closeAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
            // 清除消息
            document.getElementById('login-message').className = 'auth-message';
            document.getElementById('login-message').textContent = '';
            document.getElementById('register-message').className = 'auth-message';
            document.getElementById('register-message').textContent = '';
        }

        // 切换登录/注册表单
        function switchAuthForm(type) {
            if (type === 'login') {
                document.getElementById('login-form-container').style.display = 'block';
                document.getElementById('register-form-container').style.display = 'none';
            } else {
                document.getElementById('login-form-container').style.display = 'none';
                document.getElementById('register-form-container').style.display = 'block';
            }
        }

        // 处理登录
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const messageEl = document.getElementById('login-message');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    messageEl.className = 'auth-message error';
                    messageEl.textContent = '登录失败：' + error.message;
                } else {
                    messageEl.className = 'auth-message success';
                    messageEl.textContent = '登录成功！';
                    setTimeout(() => {
                        closeAuthModal();
                    }, 1000);
                }
            } catch (err) {
                messageEl.className = 'auth-message error';
                messageEl.textContent = '登录失败：' + err.message;
            }
        }

        // 处理注册
        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const messageEl = document.getElementById('register-message');

            if (password !== passwordConfirm) {
                messageEl.className = 'auth-message error';
                messageEl.textContent = '两次输入的密码不一致';
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    messageEl.className = 'auth-message error';
                    messageEl.textContent = '注册失败：' + error.message;
                } else {
                    messageEl.className = 'auth-message success';
                    messageEl.textContent = '注册成功！请查收验证邮件后登录。';
                }
            } catch (err) {
                messageEl.className = 'auth-message error';
                messageEl.textContent = '注册失败：' + err.message;
            }
        }

        // 退出登录
        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            updateUIForLoggedOutUser();
        }

        // 选择逆向验证源
        function selectReverseSource(source) {
            selectedReverseSource = source;
            updateReverseTitle();
        }

        // 更新逆向验证区标题
        function updateReverseTitle() {
            const title = document.getElementById('reverse-title');
            if (selectedReverseSource === 'original-eng') {
                title.textContent = '逆向验证区 (英文翻译的中文回译)';
            } else if (selectedReverseSource === 'polished-eng') {
                title.textContent = '逆向验证区 (润色英译文的中文回译)';
            }
        }

        // 区域屏蔽切换
        function toggleSection(section) {
            sectionStates[section] = !sectionStates[section];
            const btn = document.getElementById(`toggle-${section}`);
            btn.classList.toggle('active');
            btn.textContent = sectionStates[section] ? '取消屏蔽' : '屏蔽';
            updateReverseTitle();
        }

        // 模型选择切换
        document.getElementById('model-select').addEventListener('change', function() {
            currentModel = this.value;
            document.getElementById('api-key-input').value = apiKeys[currentModel] || '';
        });

        // 保存API密钥
        document.getElementById('save-api-key').addEventListener('click', function() {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                apiKeys[currentModel] = key;
                localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
                alert('API密钥已保存！');
            }
        });

        // 手动触发AI处理
        function triggerAIProcessing() {
            // 检查是否登录
            if (!currentUser) {
                alert('请先登录后再使用翻译功能！');
                showAuthModal('login');
                return;
            }

            const content = document.getElementById('original-text').value;
            if (!content) {
                alert('请先输入论文原文！');
                return;
            }
            
            const key = apiKeys[currentModel];
            if (!key) {
                alert('请先设置对应AI模型的API密钥！');
                return;
            }
            
            document.getElementById('loading-1').style.display = 'block';
            processWithAI(content);
        }

        // 调用AI处理内容
        async function processWithAI(content) {
            try {
                const title = document.getElementById('title-input').value;
                const key = apiKeys[currentModel];
                const config = modelConfigs[currentModel];
                
                // 中文润色请求
                let polishedChinese = content;
                if (!sectionStates['chinese']) {
                    const chinesePolishPrompt = `请将以下中文文本润色为学术论文规范语言，保持原意不变，提升逻辑清晰度和专业性：\n\n${content}`;
                    polishedChinese = await callAI(config, key, chinesePolishPrompt);
                    document.getElementById('chinese-polished').value = polishedChinese;
                } else {
                    document.getElementById('chinese-polished').value = '';
                }
                
                // 原文直接翻译成英文
                let translatedEnglish = '';
                if (!sectionStates['original-eng']) {
                    const translatePrompt = `请将以下中文文本翻译成符合SCI期刊标准的英文，使用学术严谨性表达，确保专业术语准确：\n\n${content}`;
                    translatedEnglish = await callAI(config, key, translatePrompt);
                    document.getElementById('english-translated').value = translatedEnglish;
                } else {
                    document.getElementById('english-translated').value = '';
                }
                
                // 润色后的中文再翻译成英文
                let polishedEnglish = '';
                if (!sectionStates['polished-eng'] && !sectionStates['chinese']) {
                    const polishedTranslatePrompt = `请将以下中文学术文本翻译成符合SCI期刊标准的英文，确保语法结构正确，学术表达严谨，专业术语准确：\n\n${polishedChinese}`;
                    polishedEnglish = await callAI(config, key, polishedTranslatePrompt);
                    document.getElementById('polished-english').value = polishedEnglish;
                } else {
                    document.getElementById('polished-english').value = '';
                }
                
                // 逆向验证
                if (!sectionStates['reverse']) {
                    let reversePrompt;
                    
                    if (selectedReverseSource === 'original-eng' && !sectionStates['original-eng']) {
                        reversePrompt = `请将以下英文学术文本翻译回中文，保持学术严谨性和原意不变：\n\n${translatedEnglish}`;
                    } else if (selectedReverseSource === 'polished-eng' && !sectionStates['polished-eng'] && !sectionStates['chinese']) {
                        reversePrompt = `请将以下英文学术文本翻译回中文，保持学术严谨性和原意不变：\n\n${polishedEnglish}`;
                    } else {
                        document.getElementById('reverse-translation').value = '';
                        document.getElementById('loading-1').style.display = 'none';
                        return;
                    }
                    
                    const reverseTranslation = await callAI(config, key, reversePrompt);
                    document.getElementById('reverse-translation').value = reverseTranslation;
                } else {
                    document.getElementById('reverse-translation').value = '';
                }
                
            } catch (error) {
                console.error('API调用错误:', error);
                alert('AI处理失败，请检查API密钥是否正确或网络连接是否正常。\n错误信息：' + error.message);
            } finally {
                document.getElementById('loading-1').style.display = 'none';
            }
        }

        // 调用不同AI模型API
        async function callAI(config, apiKey, prompt) {
            if (currentModel === 'qianwen') {
                const response = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        input: {
                            messages: [{ role: 'user', content: prompt }]
                        },
                        parameters: {
                            temperature: 0.7
                        }
                    })
                });
                
                const data = await response.json();
                if (data.output && data.output.choices && data.output.choices[0]) {
                    return data.output.choices[0].message.content;
                }
                throw new Error(data.message || 'API返回格式错误');
            } else {
                const response = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                }
                throw new Error(data.error?.message || data.message || 'API返回格式错误');
            }
        }

        // 滚动同步
        const scrollableElements = document.querySelectorAll('.synchronized-scroll');
        let isSyncing = false;

        scrollableElements.forEach(element => {
            element.addEventListener('scroll', function() {
                if (isSyncing) return;
                isSyncing = true;
                
                const scrollTop = this.scrollTop;
                scrollableElements.forEach(otherElement => {
                    if (otherElement !== this) {
                        otherElement.scrollTop = scrollTop;
                    }
                });
                
                isSyncing = false;
            });
        });

        // 复制功能
        function copyContent(elementId) {
            const element = document.getElementById(elementId);
            navigator.clipboard.writeText(element.value).then(() => {
                const originalText = element.value;
                element.value = '已复制到剪贴板！';
                setTimeout(() => {
                    element.value = originalText;
                }, 1500);
            }).catch(() => {
                // 回退方案
                element.select();
                document.execCommand('copy');
                const originalText = element.value;
                element.value = '已复制到剪贴板！';
                setTimeout(() => {
                    element.value = originalText;
                }, 1500);
            });
        }

        // 深色/浅色模式切换
        const modeToggle = document.getElementById('mode-toggle');
        modeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            this.textContent = document.body.classList.contains('dark-mode') ? '切换浅色模式' : '切换深色模式';
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        });

        // API帮助模态框控制
        const helpBtn = document.getElementById('help-btn');
        const apiHelpModal = document.getElementById('api-help-modal');
        
        helpBtn.addEventListener('click', function() {
            apiHelpModal.style.display = 'block';
        });
        
        function closeApiHelpModal() {
            apiHelpModal.style.display = 'none';
        }
        
        window.addEventListener('click', function(e) {
            if (e.target === apiHelpModal) {
                apiHelpModal.style.display = 'none';
            }
            if (e.target === document.getElementById('auth-modal')) {
                closeAuthModal();
            }
        });

        // 字体大小调节
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const textAreas = document.querySelectorAll('.editor-textarea');

        fontSizeSlider.addEventListener('input', function() {
            const size = this.value + 'px';
            fontSizeValue.textContent = size;
            
            textAreas.forEach(textArea => {
                textArea.style.fontSize = size;
            });
            
            localStorage.setItem('fontSize', this.value);
        });
    </script>
</body>
</html>
